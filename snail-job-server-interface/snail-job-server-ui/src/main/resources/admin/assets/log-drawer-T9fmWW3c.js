import{d as q,aj as H,bI as te,d3 as ne,r as b,aR as V,b as R,o as s,e as h,d4 as le,J as oe,d5 as Y,a0 as se,a1 as ae,cd as ie,q as re,d6 as ce,bZ as ue,c,cu as de,w as u,f as n,cv as pe,Q as $,h as w,bG as F,as as E,x as me,a7 as _e,g as C,t as fe,W as L,d7 as ge,d8 as ve,F as he,ah as ye,a3 as O,d9 as G,an as ke,l as be}from"./index-C0p55rrf.js";import{_ as Se,a as K}from"./CollapseItem-BWVJFROc.js";const we={scrollbarProps:Object,items:{type:Array,default:()=>[]},itemSize:{type:Number,required:!0},itemResizable:Boolean,itemsStyle:[String,Object],visibleItemsTag:{type:[String,Object],default:"div"},visibleItemsProps:Object,ignoreItemResize:Boolean,onScroll:Function,onWheel:Function,onResize:Function,defaultScrollKey:[Number,String],defaultScrollIndex:Number,keyField:{type:String,default:"key"},paddingTop:{type:[Number,String],default:0},paddingBottom:{type:[Number,String],default:0}},xe=q({name:"VirtualList",props:we,setup(d){const t=b(null),p=b(null);function i(){const{value:a}=t;a&&a.sync()}function S(a){var r;i(),(r=d.onScroll)===null||r===void 0||r.call(d,a)}function x(a){var r;i(),(r=d.onResize)===null||r===void 0||r.call(d,a)}function I(a){var r;(r=d.onWheel)===null||r===void 0||r.call(d,a)}function f(a,r){var N,z;typeof a=="number"?(N=p.value)===null||N===void 0||N.scrollTo(a,r??0):(z=p.value)===null||z===void 0||z.scrollTo(a)}function T(){var a;return(a=p.value)===null||a===void 0?void 0:a.listElRef}function g(){var a;return(a=p.value)===null||a===void 0?void 0:a.itemsElRef}return{scrollTo:f,scrollbarInstRef:t,virtualListInstRef:p,getScrollContainer:T,getScrollContent:g,handleScroll:S,handleResize:x,handleWheel:I}},render(){return H(ne,Object.assign({},this.scrollbarProps,{ref:"scrollbarInstRef",container:this.getScrollContainer,content:this.getScrollContent}),{default:()=>H(te,{ref:"virtualListInstRef",showScrollbar:!1,items:this.items,itemSize:this.itemSize,itemResizable:this.itemResizable,itemsStyle:this.itemsStyle,visibleItemsTag:this.visibleItemsTag,visibleItemsProps:this.visibleItemsProps,ignoreItemResize:this.ignoreItemResize,keyField:this.keyField,defaultScrollKey:this.defaultScrollKey,defaultScrollIndex:this.defaultScrollIndex,paddingTop:this.paddingTop,paddingBottom:this.paddingBottom,onScroll:this.handleScroll,onResize:this.handleResize,onWheel:this.handleWheel},{default:({item:d,index:t})=>{var p,i;return(i=(p=this.$slots).default)===null||i===void 0?void 0:i.call(p,{item:d,index:t})}})})}}),$e={class:"inline-block",viewBox:"0 0 14 14",width:"1em",height:"1em"};function Ie(d,t){return s(),R("svg",$e,t[0]||(t[0]=[h("g",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[h("path",{d:"M10.13 3.48L7.26.61a.36.36 0 0 0-.52 0L3.87 3.48m6.26 7.04l-2.87 2.87a.36.36 0 0 1-.52 0l-2.87-2.87"}),h("circle",{cx:"7",cy:"7",r:"1.25"})],-1)]))}const Te=V({name:"streamline-interface-arrows-vertical-scroll-point-move-scroll-vertical",render:Ie}),ze={class:"inline-block",viewBox:"0 0 14 14",width:"1em",height:"1em"};function Re(d,t){return s(),R("svg",ze,t[0]||(t[0]=[h("g",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round"},[h("path",{d:"m5 11l.5 2l-2 .5"}),h("path",{d:"M5.5 13A6.76 6.76 0 0 1 1 7a6 6 0 0 1 .66-2.736M4.95 1.36a6 6 0 0 0-2.19 1.394M9 3l-.5-2l2-.5"}),h("path",{d:"M8.5 1c2.3.84 4.5 3.42 4.5 6a6 6 0 0 1-1.731 4.2M9 12.64q.33-.117.642-.27M.5.5l13 13"})],-1)]))}const Ne=V({name:"streamline-synchronize-disable",render:Re}),Be={class:"inline-block",viewBox:"0 0 16 16",width:"1em",height:"1em"};function Ce(d,t){return s(),R("svg",Be,t[0]||(t[0]=[h("path",{fill:"currentColor","fill-rule":"evenodd",d:"M7.706.29c-.222.072-.35.2-.412.409c-.035.117-.041.389-.041 1.809c0 1.881-.002 1.857.19 2.049c.257.256.857.256 1.114 0c.192-.192.19-.168.19-2.049c0-1.82-.003-1.852-.151-2.028C8.472.333 8.339.284 8.04.276a1.7 1.7 0 0 0-.334.014M2.753 2.266c-.158.072-.391.3-.472.462a.6.6 0 0 0-.012.525c.074.165 2.398 2.497 2.581 2.59q.39.2.793-.194c.264-.258.334-.538.2-.799c-.093-.183-2.425-2.507-2.59-2.581a.64.64 0 0 0-.5-.003m10.1.016c-.123.057-.333.254-1.335 1.259c-.921.923-1.202 1.221-1.247 1.319a.62.62 0 0 0 .001.518c.07.15.3.386.455.467c.157.082.39.081.553-.002c.167-.086 2.477-2.396 2.563-2.563a.65.65 0 0 0 .003-.551a1.26 1.26 0 0 0-.454-.446a.57.57 0 0 0-.539-.001M.699 7.292q-.442.139-.441.707c.001.387.145.619.44.707c.118.035.381.041 1.81.041c1.489 0 1.688-.005 1.81-.045a.6.6 0 0 0 .384-.384c.086-.265.043-.641-.094-.827a.7.7 0 0 0-.191-.148l-.137-.076l-1.733-.006c-1.395-.004-1.756.002-1.848.031m11.046-.014a.76.76 0 0 0-.353.214c-.137.185-.18.561-.094.826c.058.18.204.326.384.384c.122.04.321.045 1.81.045c1.429 0 1.692-.006 1.81-.041c.295-.088.439-.32.44-.707c0-.385-.147-.616-.452-.708c-.103-.031-.426-.037-1.794-.035c-.918.002-1.706.012-1.751.022m-6.892 3.004c-.123.057-.333.254-1.335 1.259c-.921.923-1.202 1.221-1.247 1.319a.62.62 0 0 0 .001.518c.07.15.3.386.455.467c.157.082.39.081.553-.002c.167-.086 2.477-2.396 2.563-2.563a.65.65 0 0 0 .003-.551a1.26 1.26 0 0 0-.454-.446a.57.57 0 0 0-.539-.001m5.9-.016c-.158.072-.391.3-.472.462a.6.6 0 0 0-.012.525c.074.165 2.398 2.497 2.581 2.59q.39.2.793-.194c.264-.258.334-.538.2-.799c-.093-.183-2.425-2.507-2.59-2.581a.64.64 0 0 0-.5-.003m-3.008 1.011a.77.77 0 0 0-.353.215c-.138.186-.139.199-.139 1.997c0 1.432.006 1.695.041 1.813q.13.44.706.439q.576.002.706-.439c.062-.212.061-3.427-.002-3.612a.53.53 0 0 0-.284-.344c-.11-.06-.174-.075-.363-.082a1.5 1.5 0 0 0-.312.013"},null,-1)]))}const Le=V({name:"nonicons-loading16",render:Ce}),De={class:"inline-block",viewBox:"0 0 24 24",width:"1em",height:"1em"};function Me(d,t){return s(),R("svg",De,t[0]||(t[0]=[h("path",{fill:"currentColor",d:"m10.6 16.6l7.05-7.05l-1.4-1.4l-5.65 5.65l-2.85-2.85l-1.4 1.4zM12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"},null,-1)]))}const je=V({name:"material-symbols-check-circle",render:Me}),Ee={VITE_SERVICE_BASE_URL:"/snail-job"};function Oe(d,t){const p=window.location.protocol==="https:"?"wss://":"ws://",i=!1,{baseURL:S}=le(Ee,i),x=p+window.location.host+S,I=oe.get("token");return I?`${x}/websocket?Snail-Job-Auth=${I}&sid=${t??Y(32)}&scene=${d}`:null}const Ve={class:"flex-center"},Fe={class:"ml-6px"},qe={class:"flex-center"},We={key:0,class:"empty-height flex-center"},Pe={class:"flex items-center"},Ue={key:0,class:"h-full flex-center"},Ae=q({name:"LogDrawer",__name:"log-drawer",props:se({title:{default:void 0},drawer:{type:Boolean,default:!0},type:{default:"job"},fetchType:{default:"ws"},taskData:{default:void 0},modelValue:{default:()=>[]}},{show:{type:Boolean,default:!1},showModifiers:{}}),emits:["update:show"],setup(d){const t=d,p=ae(d,"show"),i=b(!1),S=b(!0),x=b([]),I=b();b(1);const f=b([]),T=b();b();const g=b(!0),a=()=>{var o;(o=T.value)==null||o.close()},r=()=>{a()};async function N(){z()}function z(){var o,e,y;if(g.value=!1,f.value=[],(o=T.value)==null||o.open(),t.type==="job"){const m=t.taskData,l={taskBatchId:m.taskBatchId,taskId:m.id};(e=T.value)==null||e.send(JSON.stringify(l))}if(t.type==="retry"){const m=t.taskData,l={groupName:m.groupName,retryTaskId:m.id};(y=T.value)==null||y.send(JSON.stringify(l))}}ie(()=>{r()}),re(()=>p.value,async o=>{var e;if(o&&(f.value=[],t.modelValue&&(f.value=[...t.modelValue])),!o&&t.drawer){r();return}if((o&&t.drawer||!t.drawer)&&t.type&&t.taskData){g.value=!1;let y="";const m=t.type==="job"?"JOB_LOG_SCENE":"RETRY_LOG_SCENE";if(y=Oe(m,t.taskData.id),!y){(e=window.$message)==null||e.error("Token 失效"),p.value=!1;return}T.value=ce(y,{immediate:!1,autoConnect:!1,autoReconnect:{retries:3,delay:1e3,onFailed(){var l;(l=window.$message)==null||l.error("websocket 连接失败"),p.value=!1}},onMessage:(l,_)=>{if(_.data!=="END"){const v=JSON.parse(_.data);v.key=`${v.time_stamp}-${Y(16)}`,f.value.push(v),ke(()=>{var k;i.value&&((k=I.value)==null||k.scrollTo({position:"bottom",debounce:!0}))})}else g.value=!0,a()}}),z()}},{immediate:!0});function Q(o){var D,M,j,B,P,U,A,J;const e=new Date(Number.parseInt(o==null?void 0:o.toString(),10)),y=e.getFullYear(),m=(e.getMonth()+1).toString().length===1?`0${e.getMonth()+1}`:(e.getMonth()+1).toString(),l=((D=e.getDate())==null?void 0:D.toString().length)===1?`0${e.getDate()}`:(M=e.getDate())==null?void 0:M.toString(),_=((j=e.getHours())==null?void 0:j.toString().length)===1?`0${e.getHours()}`:(B=e.getHours())==null?void 0:B.toString(),v=((P=e.getMinutes())==null?void 0:P.toString().length)===1?`0${e.getMinutes()}`:(U=e.getMinutes())==null?void 0:U.toString(),k=((A=e.getSeconds())==null?void 0:A.toString().length)===1?`0${e.getSeconds()}`:(J=e.getSeconds())==null?void 0:J.toString();return`${y}-${m}-${l} ${_}:${v}:${k}.${e.getMilliseconds()}`}const X=ue();function Z(){let o;t.type==="job"&&(o={type:t.type,taskBatchId:t.taskData.taskBatchId,jobId:t.taskData.jobId,taskId:t.taskData.id}),t.type==="retry"&&(o={type:t.type,groupName:t.taskData.groupName,retryTaskId:t.taskData.id});const e=X.resolve({path:"/log",query:o});window.open(e.href)}const ee=async o=>{{g.value&&(g.value=!1,await N());return}},W=q({setup(){if(g.value&&f.value.length===0)return()=>n(F,{class:"h-full flex-center",size:"huge"},null);const o=l=>{const _=l.throwable;if(!_)return n(O,null,null);const v=_.match(/^.+/m);if(!v)return n(O,null,null);const k=_.replace(/^.+(\n|$)/m,"");return n(K,{title:v[0],name:`throwable-${l.key}`},{default:()=>[n(G,{"content-class":"p-8px",class:"message-scroll-body","y-placement":"left"},{default:()=>[`${k}`]})]})},e=l=>{const _=l.message;if(!_)return n(O,null,null);const v=_.match(/^.+/m);if(!v)return n(O,null,null);const k=_.replace(/^.+(\n|$)/m,"").replaceAll(`
`,`
 - `);return k?n(K,{title:v[0],name:`message-${l.key}`},{default:()=>[n(G,{"content-class":"p-8px",class:"message-scroll-body","y-placement":"left"},{default:()=>[` - ${k}`]})]}):n("div",{class:"pl-6px"},[C("- "),`${_}`])},y=l=>{x.value=l},m=l=>{x.value=[]};return()=>n("code",{class:"snail-log"},[n(Se,{accordion:!0,"expanded-names":x.value,"onUpdate:expanded-names":l=>x.value=l,"on-update:expanded-names":y},{default:()=>[n(xe,{ref:I,style:{height:"100%"},class:"virtual-list",itemSize:85,paddingBottom:16,items:f.value,scrollbarProps:{xScrollable:!0},onResize:m},{default:({item:l})=>n("pre",{key:l.key,class:"min-h-85px min-w-full"},[n("div",null,[n("span",{class:"log-hljs-time inline-block"},[Q(l.time_stamp)]),n("span",{class:`log-hljs-level-${l.level} ml-12px mr-12px inline-block`},[`${l.level}`]),n("span",{class:"log-hljs-thread mr-12px inline-block"},[`[${l.host}:${l.port}]`]),n("span",{class:"log-hljs-thread mr-12px inline-block"},[`[${l.thread}]`])]),n("div",{class:"log-hljs-location"},[`${l.location}: `]),n("div",null,[e(l)]),n("div",null,[o(l)]),n(ye,null,null)])})]})])}});return(o,e)=>{const y=je,m=_e,l=Le,_=Ne,v=Te,k=ge,D=ve,M=pe,j=de;return o.drawer?(s(),c(j,{key:0,show:p.value,"onUpdate:show":e[3]||(e[3]=B=>p.value=B),width:S.value?"100%":"50%","display-directive":"if","auto-focus":!1},{default:u(()=>[n(M,{closable:""},{header:u(()=>[h("div",{class:me(["flex items-center justify-between",`tool-header${S.value?"-full":""}`])},[h("div",Ve,[g.value?(s(),c(m,{key:0},{trigger:u(()=>[n(y,{class:"text-20px color-success"})]),default:u(()=>[e[5]||(e[5]=C(" 日志加载完成 "))]),_:1})):(s(),c(m,{key:1},{trigger:u(()=>[n(w(E),{size:"small"},{icon:u(()=>[n(l)]),_:1})]),default:u(()=>[e[6]||(e[6]=C(" 日志正在加载 "))]),_:1})),h("span",Fe,fe(o.title),1)]),h("div",qe,[o.fetchType==="ws"?(s(),c(L,{key:0,size:"tiny",class:"mr-6px",icon:"solar:refresh-outline","tooltip-content":"刷新",onClick:e[0]||(e[0]=B=>ee(-1))})):$("",!0),n(L,{size:"tiny","tooltip-content":i.value?"关闭自动滚动":"开启自动滚动",onClick:e[1]||(e[1]=()=>i.value=!i.value)},{default:u(()=>[i.value?(s(),c(_,{key:0})):(s(),c(v,{key:1}))]),_:1},8,["tooltip-content"]),n(L,{size:"tiny",icon:"hugeicons:share-01","tooltip-content":"在新标签页打开",class:"ml-6px",onClick:Z}),n(L,{size:"tiny","tooltip-content":S.value?"半屏":"全屏",onClick:e[2]||(e[2]=()=>S.value=!S.value)},{default:u(()=>[S.value?(s(),c(k,{key:0})):(s(),c(D,{key:1}))]),_:1},8,["tooltip-content"])])],2)]),default:u(()=>[f.value.length===0?(s(),R("div",We,[f.value.length===0&&g.value?(s(),c(w(F),{key:0})):$("",!0),f.value.length===0&&!g.value?(s(),c(w(E),{key:1})):$("",!0)])):$("",!0),f.value.length>0?(s(),c(w(W),{key:1})):$("",!0)]),_:1})]),_:1},8,["show","width"])):(s(),c(w(he),{key:1,bordered:!1,title:o.title,size:"small",class:"h-full sm:flex-1-hidden card-wrapper"},{"header-extra":u(()=>[h("div",Pe,[n(L,{size:"tiny",class:"mr-12px","tooltip-content":i.value?"关闭自动滚动":"开启自动滚动",onClick:e[4]||(e[4]=()=>i.value=!i.value)},{default:u(()=>[i.value?(s(),c(_,{key:0})):(s(),c(v,{key:1}))]),_:1},8,["tooltip-content"]),g.value?(s(),c(m,{key:0},{trigger:u(()=>[n(y,{class:"text-20px color-success"})]),default:u(()=>[e[7]||(e[7]=C(" 日志加载完成 "))]),_:1})):(s(),c(m,{key:1},{trigger:u(()=>[n(w(E),{size:"small"},{icon:u(()=>[n(l)]),_:1})]),default:u(()=>[e[8]||(e[8]=C(" 日志正在加载 "))]),_:1}))])]),default:u(()=>[f.value.length===0?(s(),R("div",Ue,[f.value.length===0&&g.value?(s(),c(w(F),{key:0})):$("",!0),f.value.length===0&&!g.value?(s(),c(w(E),{key:1})):$("",!0)])):$("",!0),n(w(W))]),_:1},8,["title"]))}}}),Ge=be(Ae,[["__scopeId","data-v-7b8267cb"]]);export{Ge as _,je as a,Le as b};
