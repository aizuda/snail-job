import{a as ee,b as te,u as F,N as O,d as ae}from"./search-form.vue_vue_type_script_setup_true_lang-xYfW9G7N.js";import{aA as J,d as z,Q as G,z as N,R as V,S as oe,o as P,c as A,w as r,f as o,h as a,$ as t,B as L,aB as le,P as T,aC as ne,g as S,t as w,a9 as M,aD as q,aE as E,aF as se,ag as H,ay as re,az as ie,C as ue,ad as ce,aG as pe,b as me,ae as U,af as de,O as fe}from"./index-D3rICic-.js";import{_ as be}from"./select-group.vue_vue_type_script_setup_true_lang-Bk3YnuuX.js";import{_ as ge,a as he}from"./task-batch-status.vue_vue_type_script_setup_true_lang-jyvTK0pm.js";import{_ as _e}from"./datetime-range.vue_vue_type_script_setup_true_lang-LaVXNa0e.js";import{f as ve,a as ke}from"./job-8-wbHxv4.js";import{_ as ye}from"./detail-drawer-CeEIcqT0.js";import{f as je,_ as Be}from"./log-CNFmopnc.js";import{_ as Se,a as we}from"./DescriptionsItem-LhWljJnV.js";import{_ as Q}from"./Grid-CRDcRyPk.js";import"./group-frwXGSCG.js";function Ne(i){return J({url:"/job/batch/list",method:"get",params:i})}function De(i){return J({url:`/job/batch/stop/${i}`,method:"post"})}function xe(i){return J({url:`/job/batch/retry/${i}`,method:"post"})}const Ie=z({name:"JobBatchSearch",__name:"job-batch-search",props:{model:{required:!0},modelModifiers:{}},emits:G(["reset","search"],["update:model"]),setup(i,{emit:I}){const d=N(!1),f=I,_=N([]),m=V(i,"model"),g=N(m.value.jobName);function $(){g.value="",f("reset")}function D(){f("search")}async function v(){const c=await ve({keywords:g.value,groupName:m.value.groupName});_.value=c.data}function k(c){m.value.jobId=c}oe(()=>g.value,c=>{c.length!==0?v():d.value=!1});function y(c){return c.map(u=>({value:u.id,label:u.jobName}))}function j(c){return[c.label,`(${c.value})`]}return(c,u)=>{const h=ee,C=he,R=te;return P(),A(R,{"btn-span":"24 s:24 m:9 l:12 xl:15",model:m.value,onSearch:D,onReset:$},{default:r(()=>[o(h,{span:"24 s:12 m:6",label:a(t)("page.jobBatch.groupName"),path:"groupName",class:"pr-24px"},{default:r(()=>[o(be,{value:m.value.groupName,"onUpdate:value":u[0]||(u[0]=l=>m.value.groupName=l),clearable:""},null,8,["value"])]),_:1},8,["label"]),o(h,{span:"24 s:12 m:6",label:a(t)("page.jobBatch.jobName"),path:"jobName",class:"pr-24px"},{default:r(()=>[o(C,{value:g.value,"onUpdate:value":u[1]||(u[1]=l=>g.value=l),placeholder:a(t)("page.jobBatch.form.jobName"),options:y(_.value),"empty-visible":d.value,clearable:"",filterable:"","render-label":j,onSelect:k},null,8,["value","placeholder","options","empty-visible"])]),_:1},8,["label"]),o(h,{span:"24 s:12 m:6",label:a(t)("page.jobBatch.taskBatchStatus"),path:"taskBatchStatus",class:"pr-24px"},{default:r(()=>[o(ge,{value:m.value.taskBatchStatus,"onUpdate:value":u[2]||(u[2]=l=>m.value.taskBatchStatus=l),clearable:""},null,8,["value"])]),_:1},8,["label"]),o(h,{span:"24 s:24 m:15 l:12 xl:9",label:a(t)("page.common.createTime"),path:"datetimeRange",class:"pr-24px"},{default:r(()=>[o(_e,{value:m.value.datetimeRange,"onUpdate:value":u[3]||(u[3]=l=>m.value.datetimeRange=l)},null,8,["value"])]),_:1},8,["label"])]),_:1},8,["model"])}}});function Re(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!H(i)}const Te=z({name:"JobBatchDetailDrawer",__name:"job-batch-detail-drawer",props:G({rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{},logShow:{type:Boolean,default:!1},logShowModifiers:{}}),emits:["update:visible","update:logShow"],setup(i){var R,l;const I=i,d=N(),f=V(i,"visible"),_=V(i,"logShow"),{columns:m,data:g,loading:$,mobilePagination:D}=F({apiFn:ke,apiParams:{page:1,size:10,groupName:(R=I.rowData)==null?void 0:R.groupName,taskBatchId:(l=I.rowData)==null?void 0:l.id,startId:0,fromIndex:0},columns:()=>[{key:"index",title:t("common.index"),align:"center",width:64,render:e=>{async function s(){_.value=!0,d.value=e,await h()}return o(L,{type:"info",text:!0,onClick:s},{default:()=>[o("span",{class:"w-28px ws-break-spaces"},[t("page.log.view")])]})}},{key:"id",title:t("page.jobBatch.jobTask.id"),align:"left",minWidth:64},{key:"groupName",title:t("page.jobBatch.jobTask.groupName"),align:"left",minWidth:120},{key:"taskStatus",title:t("page.jobBatch.jobTask.taskStatus"),align:"left",minWidth:80,render:e=>{if(e.taskStatus===null)return null;const s=t(le[e.taskStatus]);return o(T,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[e.taskStatus]},Re(s)?s:{default:()=>[s]})}},{key:"clientInfo",title:t("page.jobBatch.jobTask.clientInfo"),align:"left",minWidth:120,render:e=>{var s;if(e.clientInfo){const p=(s=e.clientInfo)==null?void 0:s.split("@"),x=p.length>1?p[1]:"";return o("div",null,[x])}return o("div",null,[e.clientInfo])}},{key:"argsStr",title:t("page.jobBatch.jobTask.argsStr"),align:"left",minWidth:120},{key:"resultMessage",title:t("page.jobBatch.jobTask.resultMessage"),align:"left",minWidth:120},{key:"retryCount",title:t("page.jobBatch.jobTask.retryCount"),align:"left",minWidth:64},{key:"createDt",title:t("page.jobBatch.jobTask.createDt"),align:"left",minWidth:120}]}),v=N([]),k=N(),y=new AbortController,j=N(!1);let c="0",u=0;async function h(){const{data:e,error:s}=await je({taskBatchId:d.value.taskBatchId,jobId:d.value.jobId,taskId:d.value.id,startId:c,fromIndex:u,size:50});s||(j.value=e.finished,c=e.nextStartId,u=e.fromIndex,e.message&&(v.value.push(...e.message),v.value.sort((p,x)=>Number.parseInt(p.time_stamp,10)-Number.parseInt(x.time_stamp,10))),j.value||(clearTimeout(k.value),k.value=setTimeout(h,1e3)))}const C=()=>{j.value=!0,y.abort(),clearTimeout(k.value),k.value=void 0};return ne(()=>{C()}),(e,s)=>{const p=Se,x=we,b=re,K=Q,X=ie,Y=Be,Z=ye;return P(),A(Z,{modelValue:f.value,"onUpdate:modelValue":s[2]||(s[2]=n=>f.value=n),title:a(t)("page.jobBatch.detail"),width:["50%","90%"]},{default:r(()=>[o(X,{type:"segment",animated:""},{default:r(()=>[o(b,{name:0,tab:a(t)("page.log.info")},{default:r(()=>[o(x,{"label-placement":"top",bordered:"",column:2},{default:r(()=>[o(p,{label:a(t)("page.jobBatch.groupName")},{default:r(()=>{var n;return[S(w((n=e.rowData)==null?void 0:n.groupName),1)]}),_:1},8,["label"]),o(p,{label:a(t)("page.jobBatch.jobName")},{default:r(()=>{var n;return[S(w((n=e.rowData)==null?void 0:n.jobName),1)]}),_:1},8,["label"]),o(p,{label:a(t)("page.jobBatch.taskBatchStatus")},{default:r(()=>{var n;return[o(a(T),{type:a(M)((n=e.rowData)==null?void 0:n.taskBatchStatus)},{default:r(()=>{var B;return[S(w(a(t)(a(q)[(B=e.rowData)==null?void 0:B.taskBatchStatus])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),o(p,{label:a(t)("page.jobBatch.executionAt")},{default:r(()=>{var n;return[S(w((n=e.rowData)==null?void 0:n.executionAt),1)]}),_:1},8,["label"]),o(p,{label:a(t)("page.jobBatch.operationReason")},{default:r(()=>{var n;return[o(a(T),{type:a(M)((n=e.rowData)==null?void 0:n.operationReason)},{default:r(()=>{var B;return[S(w(a(t)(a(E)[(B=e.rowData)==null?void 0:B.operationReason])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),o(p,{label:a(t)("page.jobBatch.executorType")},{default:r(()=>{var n;return[o(a(T),{type:a(M)((n=e.rowData)==null?void 0:n.executorType)},{default:r(()=>{var B;return[S(w(a(t)(a(se)[(B=e.rowData)==null?void 0:B.executorType])),1)]}),_:1},8,["type"])]}),_:1},8,["label"]),o(p,{label:a(t)("page.jobBatch.executorInfo"),span:2},{default:r(()=>{var n;return[S(w((n=e.rowData)==null?void 0:n.executorInfo),1)]}),_:1},8,["label"]),o(p,{label:a(t)("common.createDt"),span:2},{default:r(()=>{var n;return[S(w((n=e.rowData)==null?void 0:n.createDt),1)]}),_:1},8,["label"])]),_:1})]),_:1},8,["tab"]),o(b,{name:1,tab:a(t)("page.log.title"),"display-directive":"if"},{default:r(()=>[o(K,{columns:a(m),data:a(g),loading:a($),remote:"","row-key":n=>n.id,pagination:a(D),class:"sm:h-full"},null,8,["columns","data","loading","row-key","pagination"])]),_:1},8,["tab"])]),_:1}),o(Y,{modelValue:v.value,"onUpdate:modelValue":s[0]||(s[0]=n=>v.value=n),show:_.value,"onUpdate:show":s[1]||(s[1]=n=>_.value=n),title:a(t)("page.log.title")},null,8,["modelValue","show","title"])]),_:1},8,["modelValue","title"])}}}),$e={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function W(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!H(i)}const Fe=z({name:"job_batch",__name:"index",setup(i){const I=ue(),d=N(),{bool:f,setTrue:_}=ce(!1),m=history.state.jobName,g=history.state.jobId,$=history.state.taskBatchStatus,{columnChecks:D,columns:v,data:k,getData:y,loading:j,mobilePagination:c,searchParams:u,resetSearchParams:h}=F({apiFn:Ne,apiParams:{page:1,size:10,groupName:null,jobName:null,taskBatchStatus:null,jobId:null,datetimeRange:pe()},searchParams:{jobId:g,jobName:m,taskBatchStatus:$},columns:()=>[{key:"id",title:t("common.index"),align:"center",width:120,render:l=>{function e(){d.value=l,_()}return o(L,{text:!0,tag:"a",type:"primary",onClick:e,class:"ws-normal"},{default:()=>[l.id]})}},{key:"groupName",title:t("page.jobBatch.groupName"),align:"left",minWidth:120},{key:"jobName",title:t("page.jobBatch.jobName"),align:"center",minWidth:120},{key:"executionAt",title:t("page.jobBatch.executionAt"),align:"center",minWidth:120},{key:"taskBatchStatus",title:t("page.jobBatch.taskBatchStatus"),align:"center",minWidth:120,render:l=>{if(l.taskBatchStatus===null)return null;const e=t(q[l.taskBatchStatus]);return o(T,{type:{1:"info",2:"info",3:"info",4:"error",5:"error",6:"error"}[l.taskBatchStatus]},W(e)?e:{default:()=>[e]})}},{key:"operationReason",title:t("page.jobBatch.operationReason"),align:"center",minWidth:120,render:l=>{if(l.operationReason===null)return null;const e=t(E[l.operationReason]);return o(T,{type:M(l.operationReason)},W(e)?e:{default:()=>[e]})}},{key:"createDt",title:t("common.createDt"),align:"center",minWidth:120},{key:"operate",title:t("common.operate"),align:"center",width:130,render:l=>o("div",{class:"flex-center gap-8px"},[l.taskBatchStatus===1||l.taskBatchStatus===2?o(O,{onPositiveClick:()=>R(l.id)},{default:()=>t("common.confirmStop"),trigger:()=>{let e;return o(L,{type:"error",text:!0,ghost:!0,size:"small"},W(e=t("common.stop"))?e:{default:()=>[e]})}}):"",l.taskBatchStatus===4||l.taskBatchStatus===5||l.taskBatchStatus===6?o(O,{onPositiveClick:()=>C(l.id)},{default:()=>t("common.confirmRetry"),trigger:()=>{let e;return o(L,{type:"error",text:!0,ghost:!0,size:"small"},W(e=t("common.retry"))?e:{default:()=>[e]})}}):""])}]});async function C(l){var s;const{error:e}=await xe(l);e||((s=window.$message)==null||s.success(t("common.operateSuccess")),y())}async function R(l){var s;const{error:e}=await De(l);e||((s=window.$message)==null||s.success(t("common.operateSuccess")),y())}return(l,e)=>{const s=ae,p=Q,x=fe;return P(),me("div",$e,[o(Ie,{model:a(u),"onUpdate:model":e[0]||(e[0]=b=>U(u)?u.value=b:null),onReset:a(h),onSearch:a(y)},null,8,["model","onReset","onSearch"]),o(x,{title:a(t)("page.jobBatch.title"),bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper","header-class":"view-card-header"},{"header-extra":r(()=>[o(s,{columns:a(D),"onUpdate:columns":e[1]||(e[1]=b=>U(D)?D.value=b:null),loading:a(j),"show-delete":!1,"show-add":!1,onRefresh:a(y)},null,8,["columns","loading","onRefresh"])]),default:r(()=>[o(p,{columns:a(v),data:a(k),"flex-height":!a(I).isMobile,"scroll-x":962,loading:a(j),remote:"","row-key":b=>b.id,pagination:a(c),class:"sm:h-full"},null,8,["columns","data","flex-height","loading","row-key","pagination"])]),_:1},8,["title"]),a(f)?(P(),A(Te,{key:0,visible:a(f),"onUpdate:visible":e[2]||(e[2]=b=>U(f)?f.value=b:null),"row-data":d.value},null,8,["visible","row-data"])):de("",!0)])}}});export{Fe as default};
